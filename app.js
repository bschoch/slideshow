var kue = require('kue')
var jobs = kue.createQueue({
  redis: {
    host: '159.203.212.134',
    options: {
      socket_keepalive: true,
      retry_strategy: function (options) {
        return 300
      }
    }
  }
})
jobs.watchStuckJobs()

global.jobs = jobs
var facebook = require('./facebook.js')
var slideshow = require('./slideshow.js')

var timesMap = {
  "LCD-Soundsystem_Dance-Yourself-Clean.mp4": [626, 600, 597, 640, 600, 600, 762, 759, 920, 640, 600, 601, 639, 600, 599, 642, 598, 602, 598, 639, 600, 600, 641, 601, 599, 643, 599, 601, 636, 601, 599, 601, 640, 600, 601, 639, 600, 601, 639, 600, 599, 601, 640, 601, 599, 639, 600, 600, 641, 600, 600, 642, 599, 600, 600, 638, 600, 600, 640, 601, 600, 639, 600, 600, 641, 599, 601, 599, 640, 599, 601, 639, 600, 600, 641, 601, 600, 639, 600, 600, 600, 1080, 760, 641, 598, 602, 638, 600, 520, 721, 600, 600, 600, 640, 602, 598, 919, 641, 920, 600, 600, 1079, 600, 561, 518, 761, 760, 642, 558, 642, 920, 759, 759, 923, 640, 917, 560, 644, 1239, 598, 639, 1040, 763, 639, 599, 601, 638, 600, 600, 642, 598, 599, 601, 639, 600, 640, 1043, 758, 641, 601, 598, 640, 599, 601, 599, 921, 640, 921, 599, 601, 1238, 601, 642, 1037, 761, 638, 601, 599, 642, 600, 599, 641, 602, 600, 600, 637, 600, 600, 639, 601, 600, 640, 601, 599, 640, 600, 520, 600, 680, 642, 519, 718, 600, 600, 921, 760, 800, 600, 602, 638, 562, 638, 599, 640, 600, 600, 640, 600, 600, 600, 641, 599, 601, 640, 602, 518, 559, 601, 600, 799, 601, 599, 600, 642, 598, 602, 638, 600, 600, 641, 599, 601, 638, 600, 600, 641, 600, 601, 599, 1080, 759, 640, 601, 599, 640, 602, 599, 640, 601, 599, 601, 639, 600, 600, 920, 922, 637, 600, 600, 1241, 600, 600, 639, 603, 597, 640, 601, 603, 599, 640, 597, 603, 637, 600, 601, 640, 1200, 1239, 601, 599, 639, 600, 1241, 601, 599, 920, 599, 961, 1040, 1400, 600, 600, 639, 600, 601, 640, 600, 600, 642, 598, 602, 918, 599, 641, 599, 600, 643, 597, 602, 638, 600, 599, 642, 599, 600, 600, 640, 602, 600, 638, 600, 600, 640, 599, 601, 640, 601, 599, 599, 641, 600, 600, 642, 598, 602, 637, 600, 600, 642, 599, 599, 601, 642, 600, 599, 639, 599, 600, 641, 600, 599, 640, 601, 599, 601, 919, 640, 601, 599, 640, 601, 599, 920, 642, 598, 601, 599, 641, 601, 601, 758, 919, 800, 600, 600, 639, 600, 601, 599, 642, 599, 601, 640, 600, 600, 919, 761, 639, 600, 759, 600, 642, 600, 600, 638, 601, 600, 602, 640, 597, 602, 639, 599, 603, 638, 599, 600, 643, 757, 924, 597, 759, 761, 639, 600, 761, 601, 637, 763, 599, 601, 758, 640, 600, 602, 638, 599, 601, 639, 600, 602, 918, 640, 600, 601, 599, 641, 880, 640, 601, 639, 600, 599, 640, 601, 599, 601, 640, 600, 600, 600, 639, 600, 600, 600, 640, 600, 643, 599, 601, 637, 600, 599, 641, 600, 600, 640, 601, 599, 601, 640, 600, 600, 640, 600, 601, 638, 761, 1038, 641, 600, 601, 641, 600, 598, 639, 600, 600, 640, 600, 600, 640, 921, 879, 641, 599, 601, 642, 597, 761, 919, 601, 640, 759, 600, 600, 921, 639, 600, 600, 761, 638, 762, 599, 639, 601, 599, 600, 641, 600, 601, 759, 919, 641, 599, 602, 640, 598, 601, 759, 641, 601, 600, 638, 601, 599, 600, 641, 599, 603, 638, 599, 601, 761, 639, 601, 598, 640, 602, 598, 640, 602, 758, 601, 1238, 603, 598, 640, 600, 600, 639, 602, 598, 642, 600, 600, 638, 601, 599, 763, 757, 920, 640, 601, 600, 641, 598, 602, 598, 641, 600, 600, 602, 638, 561, 678, 600, 600, 642, 599, 601, 518, 721, 599, 601, 641, 599, 601, 638, 600, 600, 642, 598, 600, 601, 641, 600, 600, 638, 600, 599, 642, 600, 599, 640, 601, 598, 921, 640, 600, 602, 598, 642, 598, 602, 639, 599, 600, 642, 600, 600, 637, 600, 600, 760, 640, 720, 800, 601, 763, 598, 638, 600, 600, 642, 920, 600, 600, 638, 600, 600, 842, 558, 600, 600, 641, 601, 598, 760, 641, 600, 601, 599, 642, 599, 601, 637, 600, 600, 642, 599, 600, 638, 603, 598, 920, 640, 601, 599, 604, 639, 598, 923, 597, 643, 597, 598, 602, 643, 597, 600, 643, 595, 601, 642, 599, 601, 637, 601, 599, 641, 600, 600, 641, 600, 601, 599, 638, 600, 600, 642, 599, 600, 640, 600, 601, 601, 637, 600, 600, 642, 599, 759, 1080, 599, 642, 600, 600, 639, 761, 1040, 639, 600, 600, 641, 759, 761, 759, 600, 639, 601, 601, 759, 639, 561, 639, 602, 598, 640, 600, 641, 600, 1079, 763, 599, 638, 600, 600, 600, 600, 641, 599, 642, 598, 600, 641, 919, 1200, 600, 642, 599, 601, 638, 600, 599, 643, 598, 602, 637, 601, 599, 601, 1840, 1242, 599, 639, 599, 601, 599, 642, 599, 600, 642, 599, 601, 637, 601, 599, 643, 599, 601, 598, 639, 600, 600, 641, 600, 600, 642, 600, 600, 598, 639, 600, 600, 641, 600, 600, 641, 599, 601, 599, 640, 600, 760, 763, 917, 639, 599, 600, 641, 600, 601],
  "Shakey-Graves_Family-and-Genus.mp4": [12763, 7958, 3479, 8482, 1320, 4239, 561, 518, 520, 520, 559, 522, 519, 560, 520, 520, 519, 521, 560, 521, 519, 802, 518, 520, 800, 561, 519, 520, 561, 520, 519, 521, 560, 519, 799, 521, 520, 1080, 520, 1080, 519, 2121, 519, 520, 561, 522, 797, 520, 1320, 800, 521, 559, 801, 800, 519, 800, 520, 800, 801, 1079, 521, 519, 560, 520, 520, 520, 802, 562, 516, 800, 521, 801, 1078, 762, 1078, 519, 1081, 521, 519, 839, 520, 522, 518, 763, 837, 800, 601, 720, 520, 520, 521, 559, 520, 521, 558, 522, 521, 557, 522, 518, 560, 521, 522, 557, 521, 519, 521, 519, 521, 560, 519, 520, 520, 560, 521, 519, 560, 521, 519, 559, 761, 561, 519, 521, 559, 801, 519, 1081, 519, 800, 523, 517, 560, 760, 560, 640, 1482, 519, 800, 800, 518, 520, 560, 520, 521, 561, 518, 1040, 560, 521, 800, 562, 757, 520, 800, 561, 519, 521, 519, 520, 840, 520, 520, 800, 1040, 842, 1039, 561, 520, 1038, 762, 519, 879, 560, 1001, 518, 521, 522, 558, 520, 560, 520, 520, 523, 556, 521, 523, 518, 559, 519, 800, 800, 521, 560, 519, 520, 520, 560, 521, 519, 560, 522, 518, 521, 519, 560, 521, 519, 523, 560, 520, 520, 558, 519, 520, 521, 1080, 523, 556, 761, 560, 759, 560, 800, 1321, 800, 560, 640, 919, 799, 800, 563, 758, 519, 1081, 520, 522, 558, 562, 517, 520, 522, 520, 522, 516, 840, 760, 561, 522, 557, 522, 678, 640, 800, 520, 520, 560, 521, 519, 800, 800, 521, 961, 918, 800, 521, 519, 522, 559, 521, 520, 522, 556, 522, 800, 2400, 517, 801, 639, 682, 800, 800, 519, 560, 521, 519, 521, 559, 802, 758, 559, 522, 520, 521, 1079, 519, 521, 559, 522, 521, 558, 521, 521, 796, 520, 562, 521, 957, 640, 800, 521, 559, 520, 521, 519, 800, 560, 522, 518, 521, 561, 518, 521, 520, 559, 521, 520, 521, 558, 521, 520, 560, 520, 521, 518, 803, 798, 520, 519, 563, 679, 638, 520, 563, 759, 558, 524, 796, 520, 561, 519, 521, 799, 520, 799, 522, 800, 1080, 520, 800, 559, 520, 1040, 802, 2158, 1842, 518, 800, 1279, 1081, 801, 2321, 1879, 8399, 1520, 1039, 13002, 6518, 1840, 560, 2281, 7398],
  "The-Lumineers_Sleep_on_the_Floor.mp4": [735,7178,927,876,1749,900,898,1774,874,902,1774,899,904,896,226,604,446,274,226,1774,251,525,1002,875,849,298,551,748,1950,302,449,1025,950,925,325,526,878,896,1201,548,450,425,928,847,351,574,451,299,1028,1302,273,1097,879,1776,872,898,678,221,327,549,500,250,1051,900,427,448,727,1022,927,424,423,902,1803,221,651,724,1051,877,297,399,227,352,526,896,874,425,425,676,249,903,900,399,374,1001,875,2926,3975,2422,301,399,928,676,946,853,748,826,798,249,325,804,247,827,523,679,824,800,401,2045,225,575,376,826,750,498,400,402,399,1426,652,346,427,373,828,624,601,400,597,628,400,599,223,400,375,426,399,401,250,1377,374,448,275,929,624,597,399,826,826,603,395,580,425,397,803,623,600,426,348,453,421,400,399,602,227,396,403,401,396,830,395,401,374,426,401,400,399,424,400,401,427,372,428,397,279,549,801,296,529,800,824,374,423,801,678,946,804,798,824,824,377,449,1752,801,623,1002,697,1578,825,398,222,976,829,797,801,1601,1226,400,820,829,799,776,849,398,399,830,221,551,848,1628,1623,801,2124,1729,947,877,871,250,603,474,273,225,876,876,225,1498,702,249,801,272,580,800,220,1701,299,505,948,998,1077,675,747,1905,297,599],
  "Zhu_Hold-Up-Wait-A-Minute.mp4": [253,600,1026,251,223,577,524,476,472,579,497,525,476,574,501,524,474,1126,976,524,526,550,473,527,501,547,479,549,497,550,499,251,275,275,249,275,225,277,248,276,249,250,250,525,775,255,270,251,276,251,249,250,273,250,250,277,498,253,797,1028,522,525,500,525,525,251,250,274,250,277,249,251,248,525,501,528,522,277,248,251,250,250,273,376,274,250,300,225,301,224,250,276,374,250,400,500,350,325,250,226,224,251,324,275,251,250,276,250,400,399,249,250,252,250,249,373,426,250,252,272,250,228,298,249,375,300,350,525,500,401,250,274,250,251,400,251,273,252,526,523,226,274,250,249,278,274,253,271,224,277,500,277,272,502,272,250,376,274,250,400,227,273,275,376,400,250,250,275,525,224,278,223,299,251,249,350,578,372,255,522,498,553,497,275,250,276,251,249,250,250,424,377,249,250,274,251,274,227,273,250,277,250,251,272,251,374,402,250,400,349,301,250,275,248,250,277,248,251,251,423,376,249,301,223,250,277,249,249,277,249,250,275,250,251,779,398,399,250,775,250,549,226,248,274,251,275,249,252,273,250,400,250,276,374,250,250,276,249,251,399,300,226,251,274,375,254,247,274,249,251,278,249,249,273,251,249,275,253,249,273,400,250,276,351,273,250,277,250,250,250,273,425,325,1003,248,249,276,349,401,400,226,399,401,249,374,375,250,253,272,227,799,449,275,227,348,325,250,425,400,325,428,272,225,525,225,251,300,226,250,273,377,600,273,325,378,324,449,351,223,299,226,300,229,295,327,398,252,500,299,502,322,375,226,450,579,246,400,526,503,248,249,273,277,773,250,250,275,250,260,516,501,273,252,250,273,525,252,248,275,251,274,250,500,276,251,523,250,278,499,278,246,249,278,249,250,523,276,251,250,523,250,275,252,373,400,275,2554,497,551,525,251,249,274,248,250,276,253,422,350,275,225,277,251,271,251,275,251,251,272,251,252,248,399,400,251,250,275,250,250,250,275,249,276,251,249,276,224,427,373,250,299,227,524,249,276,252,250,249,273,250,250,276,524,375,401,250,776,249,578,222,250,249,255,271,249,275,252,250,273,250,250,279,249,248,274,250,250,275,250,252,273,250,251,274,252,250,273,250,250,277,250,249,274,250,400,275,250,250,250,400,251,250,277,249,249,301,223,251,277,250,249,273,250,250,226,251,451,376,246,225,300,525,249,277,500,524,475,575,500,526,478,321,750,1025,777,273,224,278,522,250,276,502,525,474,576,500,524,499,301,752,498,524,251,524,477,300,776,801,496,475,551,550,501,499,298,753,522,250,250,250,276,249,476,300,526,249,276,524,500,477,575,501,522,499,1050,501,400,399,251,274,250,425,350,251,525,252,249,250,274,249,277,250,250,272,252,248,279,249,247,275,250,251,276,249,252,273,249,251,276,249,274,250,250,251,276,252,274,248,249,275,250,251,278,251,246,275,249,251,276,251,250,274,248,278,249,250,273,250,250,277,248,252,523,275,250,252,250,523,251,399,401,249,376,275,374,250,276,250,274,251,251,275,251,249,398,378,252,273,249,273,251,249,277,250,250,423,350,275,250,252,273,250,400,380,270,250,250,250,275,250,275,250,250,400,375,276,399,375,250,275,502,398,400,980,646],
  "Hermitude_The-Buzz.mp4": [77,476,1248,2101,1277,1324,826,1274,1051,1075,1273,1274,425,424,426,425,425,225,426,401,226,423,423,227,423,627,226,424,424,426,423,429,425,623,223,227,423,400,426,224,225,403,223,225,400,226,223,426,424,428,1274,1677,1723,1698,854,847,851,853,849,847,902,371,426,855,295,552,348,274,225,276,575,250,525,325,225,374,428,224,249,451,324,303,399,498,402,349,302,299,450,272,501,550,299,2553,498,575,300,477,423,226,351,222,428,422,250,226,378,473,303,321,379,220,227,448,1025,255,222,373,275,376,249,380,424,249,223,300,551,375,250,223,378,272,429,1025,246,225,426,226,350,223,425,401,274,225,354,271,225,450,401,375,500,350,850,926,424,351,422,428,272,227,349,505,295,325,576,423,300,577,423,426,852,423,425,226,626,424,449,425,452,375,1327,673,1425,3326,897,850,852,447,400,853,850,952,222,527,846,851,851,448,399,501,1653,673,1028,447,2101,473,3776,425,450,1249,1253,448,676,1176,697,853,321,326,225,325,299,226,626,228,246,475,326,224,425,302,551,401,320,326,224,428,249,373,227,423,300,326,224,225,525,525,425,225,426,951,423,930,873,447,226,424,375,224,251,425,425,405,220,224,426,225,400,225,425,426,424,604,245,426,225,276,324,226,225,223,378,250,224,399,227,422,226,424,400,278,1422,227,223,227,398,225,325,302,223,427,424,400,250,676,249,325,603,446,853,447,480,373,222,426,424,426,424,426,424,425,425,651,374,275,576,679,421,225,399,650,225,428,397,452,625,223,351,500,424,253,574,449,424,326,274,224,654,223,224,425,301,324,425,224,426,502,823,549,680,248,372,227,849,425,250,349,675,525,327,899,978,926,395,400,653,226,425,372,474,427,823,701,6951,851,952,550,1046,650,629,1070,625,426,651,1274,424,225,1476,651,1047,226,424,2229,3949],
  "Aesop-Rock_Kirby.mp4": [130,523,349,324,1005,470,350,351,324,328,347,326,349,275,226,325,349,327,348,500,350,501,351,325,324,349,275,225,325,350,329,348,323,275,249,330,348,827,346,327,350,322,351,327,325,347,355,322,351,322,350,328,322,350,328,348,325,349,351,325,375,1978,347,501,475,351,351,525,324,348,302,525,347,327,300,323,227,652,323,498,377,348,275,226,324,500,350,326,350,327,348,350,650,350,252,300,275,323,324,376,324,326,524,327,349,250,224,705,499,347,274,300,275,325,325,351,328,325,371,302,526,299,373,349,328,350,322,527,324,327,273,400,350,326,348,503,348,450,225,324,351,325,325,350,300,377,249,250,501,523,327,523,399,250,350,327,350,298,378,323,350,324,326,351,500,349,349,825,301,300,251,324,350,325,349,503,676,296,376,324,675,352,323,350,327,349,324,326,300,374,354,322,274,251,250,249,351,650,351,324,349,326,352,322,350,327,323,350,525,502,323,500,527,323,350,325,350,325,276,224,500,350,250,250,525,326,500,351,324,325,348,326,524,380,1296,524,325,829,271,351,226,498,280,221,274,251,324,350,325,351,324,252,275,702,321,476,274,228,350,327,345,327,399,274,350,350,327,448,551,424,353,247,326,349,325,500,250,251,351,350,223,277,350,251,572,350,400,253,273,251,323,326,351,323,353,323,351,349,228,446,276,726,223,276,378,296,351,325,501,227,295,328,347,451,224,428,399,350,323,228,322,300,327,348,325,503,347,326,600,275,652,348,499,326,350,326,250,275,298,350,427,250,350,500,349,501,499,351,223,277,500,349,251,423,226,501,323,325,302,248,379,372,349,326,352,325,347,326,349,325,350,329,348,323,350,326,499,375,300,500,351,326,348,351,324,325,350,250,250,300,225,326,500,499,349,328,349,324,349,278,401,323,348,250,251,500,349,501,350,326,325,325,300,223,327,352,1376,222,224,378,498,326,351,321,327,351,350,322,350,327,348,325,250,250,350,351,650,349,326,499,350,325,351,325,349,326,350,251,249,351,323]

}

var tempPath = 'temp'
var imagesPath = 'images'

var commandLineArguments = process.argv.slice(2);
commandLineArguments.forEach(function (arg) {
  var args = arg.split("=")
  if (args.length > 1) {
    switch (args[0]) {
      case "-tempPath":
        tempPath = args[1]
        break;
      case "-imagesPath":
        imagesPath = args[1]
        break;
    }
  }
})

console.log("starting reading from queue")
var errors
jobs.process('slideshows', function (job, done) {
  errors = {}
  var urls = job.data.urls
  var token = job.data.token
  var songPath = job.data.songPath
  console.log("processing token " + job.data.token)
  return facebook.getPhotos({token: token, imagesPath: imagesPath}).then(function () {
    console.log("get photos complete")
    return slideshow.create({
      track: "./audio/" + songPath,
      times: timesMap[songPath],
      imagesPath: imagesPath,
      tempPath: tempPath
    }).then(function () {
      console.log("slideshow complete")
      return facebook.uploadVideo({
        outputFile: tempPath + '/output.mp4',
        token: job.data.token
      }).then(function (data) {
        console.log("SLIDESHOW_SUCCESS", data.id)
        console.log("NON_FATAL_ERRORS", errors)
        return done()
      })
    })
  }).fail(function (err) {
    console.log("SLIDESHOW_ERROR", err)
    console.log("NON_FATAL_ERRORS", errors)
    return done(err)
  })
})

jobs.on('error', function (err) { // listening to error is required to ignore them
  console.log("ERROR", err)
  if (isNaN(errors[err])) {
    errors[err] = 1
  } else {
    errors[err]++
  }
})
